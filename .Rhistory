Age <= 3  ~ "18-34",   # Young adults
Age <= 6  ~ "35-49",   # Middle age
Age <= 9  ~ "50-64",   # Older adults
Age <= 11 ~ "65-74",   # Elderly
TRUE      ~ "75+"      # Very elderly
),
AgeBand = factor(AgeBand, ordered = TRUE)
)
# Display AgeBand mapping
df_clean %>%
select(Age, AgeBand) %>%
head(10)
# Frequency of age bands
table(df_clean$AgeBand)
# -----------------------------------------------------
# Lifestyle Risk Score (Composite Feature)
# -----------------------------------------------------
# Combine multiple unhealthy lifestyle behaviors into a single numerical risk score.
# Higher score indicates less healthy lifestyle.
df_clean <- df_clean %>%
mutate(
RiskScore =
as.numeric(Smoker) +              # Smoking behavior
as.numeric(HvyAlcoholConsump) +   # Heavy drinking behavior
(1 - as.numeric(PhysActivity)) +  # Inactivity
(1 - as.numeric(Fruits)) +        # Low fruit intake
(1 - as.numeric(Veggies))         # Low vegetable intake
)
# Inspect calculated RiskScore
df_clean %>%
select(Smoker, HvyAlcoholConsump, PhysActivity, Fruits, Veggies, RiskScore) %>%
head(10)
summary(df_clean$RiskScore)
# -----------------------------------------------------
# Disease Burden Index (Chronic Disease Count)
# -----------------------------------------------------
# Counts the number of existing health conditions per individual.
# Represents overall comorbidity burden.
df_clean <- df_clean %>%
mutate(
DiseaseCount =
as.numeric(HighBP) +      # High blood pressure
as.numeric(HighChol) +    # High cholesterol
as.numeric(Diabetes) +    # Diabetes
as.numeric(Stroke)        # History of stroke
)
# Inspect disease burden result
df_clean %>%
select(HighBP, HighChol, Diabetes, Stroke, DiseaseCount) %>%
head(10)
table(df_clean$DiseaseCount)
# -----------------------------------------------------
# Health Stress Index (Mental + Physical Health)
# -----------------------------------------------------
# Combines mental and physical unhealthy days into one stress indicator.
df_clean <- df_clean %>%
mutate(
HealthStressIndex = MentHlth + PhysHlth
)
# Inspect health stress indicator
df_clean %>%
select(MentHlth, PhysHlth, HealthStressIndex) %>%
head(10)
summary(df_clean$HealthStressIndex)
# -----------------------------------------------------
# Healthcare Access Score
# -----------------------------------------------------
# Captures access to healthcare services combining insurance and affordability.
df_clean <- df_clean %>%
mutate(
HealthcareScore =
as.numeric(AnyHealthcare) +       # Has insurance
(1 - as.numeric(NoDocbcCost))     # Could afford doctor visit
)
# Inspect healthcare access score
df_clean %>%
select(AnyHealthcare, NoDocbcCost, HealthcareScore) %>%
head(10)
table(df_clean$HealthcareScore)
# -----------------------------------------------------
# Obesity Indicator
# -----------------------------------------------------
# Create obesity flag using BMI threshold (BMI >= 30 is obese).
df_clean <- df_clean %>%
mutate(
ObeseFlag = ifelse(BMI >= 30, 1, 0),
ObeseFlag = factor(ObeseFlag)
)
# Inspect obesity flag
df_clean %>%
select(BMI, ObeseFlag) %>%
head(10)
table(df_clean$ObeseFlag)
# -----------------------------------------------------
# Lifestyle Risk Category
# -----------------------------------------------------
# Convert numeric RiskScore into interpretable risk classes.
df_clean <- df_clean %>%
mutate(
LifestyleProfile = case_when(
RiskScore <= 1 ~ "Healthy",
RiskScore <= 3 ~ "ModerateRisk",
TRUE ~ "HighRisk"
),
LifestyleProfile = factor(LifestyleProfile)
)
# Inspect lifestyle categories
df_clean %>%
select(RiskScore, LifestyleProfile) %>%
head(10)
table(df_clean$LifestyleProfile)
# =========================================================
# EDA
# =========================================================
df_plot <- df_clean %>%
mutate(
HeartDisease = factor(HeartDiseaseorAttack,
levels = c(0, 1),
labels = c("No", "Yes")),
SexLabel = factor(Sex,
levels = c(0, 1),
labels = c("Female", "Male"))
)
# --------------------------------
# 9.1 Target variable distribution                                              # GOOD
# --------------------------------
df_donut <- df_plot %>%
count(HeartDisease) %>%
mutate(prop = n / sum(n))
ggplot(df_donut, aes(x = 2, y = prop, fill = HeartDisease)) +
geom_col(width = 1) +
coord_polar(theta = "y") +
xlim(0.5, 2.5) +
theme_void() +
labs(title = "Heart Disease Prevalence (Donut Chart)") +
geom_text(aes(label = percent(prop)),
position = position_stack(vjust = 0.5))
# ---------------------------------
# 9.2 Heart disease rate by AgeBand
# ---------------------------------
# Two choose one(i think below one better)
ggplot(df_plot, aes(x = AgeBand, fill = HeartDisease)) +
geom_bar(position = "fill") +
scale_y_continuous(labels = percent) +
labs(title = "Heart Disease Rate by Age Band",
x = "Age Band",
y = "Proportion") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
counts <- table(df_plot$HeartDisease)                                           # ok
barplot(counts,
col = "#2C82C9",
border = NA,
main = "Heart Disease Prevalence",
xlab = "Heart Disease",
ylab = "Count")
# ---------------------------------
# 9.3 Heart disease rate by Sex
# ---------------------------------
# Two choose one(i think upper one better)
ggplot(df_plot, aes(x = SexLabel, fill = HeartDisease)) +                       # ok
geom_bar(position = "fill", color = "white") +
scale_fill_manual(values = c("#F76C6C", "#1ECBE1")) +
scale_y_continuous(labels = percent) +
labs(title = "Heart Disease Rate by Sex",
x = "Sex",
y = "Proportion") +
theme_minimal(base_size = 14)
par(mfrow = c(1,2))
for (sex in levels(df_plot$SexLabel)) {
tab <- table(df_plot$HeartDisease[df_plot$SexLabel == sex])
pie(tab,
col = c("#F76C6C", "#1ECBE1"),
main = paste("Heart Disease Rate:", sex))
}
par(mfrow = c(1,1))
# ---------------------------------
# 9.4 BMI category vs HeartDisease                                              # ok
# ---------------------------------
ggplot(df_plot, aes(BMI_Category, fill = HeartDisease)) +
geom_bar(position = "fill", color = "white") +
scale_fill_manual(values = c("#F9A825", "#1976D2")) +
labs(title = "Heart Disease Rate by BMI Category",
x = "BMI Category",
y = "Proportion") +
scale_y_continuous(labels = percent) +
theme_minimal(base_size = 14)
# ---------------------------------
# 9.5 Obesity flag vs HeartDisease
# ---------------------------------
# Two choose one(i think below one better)
ggplot(df_plot, aes(x = ObeseFlag, fill = HeartDisease)) +
geom_bar(position = "fill") +
scale_y_continuous(labels = percent) +
labs(title = "Heart Disease Rate by Obesity Status (BMI ≥ 30)",
x = "ObeseFlag (0 = No, 1 = Yes)",
y = "Proportion")
ggplot(df_plot, aes(factor(ObeseFlag), fill = HeartDisease)) +                  # ok
geom_bar(position = "fill", width = 0.5) +
scale_fill_manual(values = c("#81D4FA", "#EF5350")) +
labs(title = "Heart Disease Rate by Obesity Status",
x = "Obesity (0 = No, 1 = Yes)",
y = "Proportion") +
scale_y_continuous(labels = percent) +
theme_minimal(base_size = 14)
# -------------------------------------
# 9.6 LifestyleProfile vs HeartDisease
# -------------------------------------
# Two choose one(i think below one better)
ggplot(df_plot, aes(LifestyleProfile, fill = HeartDisease)) +
geom_bar(position = "fill", color = "white") +
scale_fill_manual(values = c("#43A047", "#EF5350")) +
scale_y_continuous(labels = percent) +
labs(title = "Heart Disease Rate by Lifestyle Profile",
x = "Lifestyle Category",
y = "Proportion") +
theme_minimal(base_size = 14)
tab <- table(df_plot$LifestyleProfile, df_plot$HeartDisease)                    # ok
barplot(prop.table(tab, 1),
beside = FALSE,
col = c("#43A047", "#EF5350"),
legend = TRUE,
main = "Heart Disease Rate by Lifestyle Profile")
# -------------------------------------
# 9.7 General health (GenHlth_Factor)                                           # ok
# -------------------------------------
ggplot(df_plot, aes(x = GenHlth_Factor, fill = HeartDisease)) +
geom_bar(position = "fill") +
scale_y_continuous(labels = percent) +
labs(title = "Heart Disease Rate by Self-Reported General Health",
x = "General Health",
y = "Proportion") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
#--------------These 2 no idea need or not(if no need drop it)---------------------------------------------------
# -------------------------------------
# 9.8 DiseaseCount vs HeartDisease
# -------------------------------------
ggplot(df_plot, aes(x = factor(DiseaseCount), fill = HeartDisease)) +
geom_bar(position = "fill") +
scale_y_continuous(labels = percent) +
labs(title = "Heart Disease Rate by Disease Burden",
x = "Number of Chronic Conditions",
y = "Proportion")
# --------------------------------------------------------
# 9.9 HealthStressIndex distribution (MentHlth + PhysHlth)
# --------------------------------------------------------
ggplot(df_plot, aes(x = HealthStressIndex)) +
geom_histogram(binwidth = 2, fill = "darkseagreen3", color = "white") +
labs(title = "Health Stress Index Distribution",
x = "HealthStressIndex (MentHlth + PhysHlth)",
y = "Count")
#----------------------------------------------------------------------------------------------------------------
# --------------------------------------
# 9.10 HealthStressIndex vs HeartDisease
# --------------------------------------
# Two choose one(i think below one better)
ggplot(df_plot, aes(x = HeartDisease, y = HealthStressIndex, fill = HeartDisease)) +
geom_boxplot() +
labs(title = "Health Stress Index by Heart Disease Status",
x = "Heart Disease or Attack",
y = "HealthStressIndex")
boxplot(HealthStressIndex ~ HeartDisease,                                       # ok
data = df_plot,
col = c("#4DB6AC", "#FF7043"),
main = "Health Stress Index by Heart Disease",
xlab = "Heart Disease",
ylab = "Health Stress Index")
# -----------------------------------------
# 9.10 Healthcare Access Score Distribution                                     # ok
# -----------------------------------------
df_healthcare <- df_plot %>%
group_by(HealthcareScore) %>%
summarise(Count = n()) %>%
mutate(Percent = Count / sum(Count))
ggplot(df_healthcare, aes(x = factor(HealthcareScore), y = Percent)) +
geom_col(fill = "olivedrab3") +
geom_text(aes(label = percent(Percent)), vjust = -0.5) +
labs(title = "Healthcare Access Score Distribution (Waffle-style Bar)",
x = "Healthcare Score",
y = "Percent")
# =========================================================
# 10. Full-feature correlation analysis (memory safe)
# =========================================================
# 1) Build a numeric-only version of df_clean
#    - Encode HeartDiseaseorAttack as numeric 0/1
#    - Convert ALL remaining factors to numeric codes
df_corr <- df_clean %>%
mutate(
HeartDisease_num = as.numeric(as.character(HeartDiseaseorAttack))
) %>%
select(-HeartDiseaseorAttack) %>%       # avoid duplicate target
mutate(
across(where(is.factor), ~ as.numeric(.))   # all factors -> numeric codes
)
# Optional: check dimensions (should be features x features later)
cat("Number of features used for correlation:", ncol(df_corr), "\n")
# 2) Compute correlation matrix across ALL features
cor_mat <- cor(df_corr, use = "pairwise.complete.obs")
# Quick sanity check
dim(cor_mat)
# Should be something like 23 x 23 (depending on how many columns you have)
#=========================================================================================
#=========================================================================================
#=========================================================================================
#=========================================================================================
### Choose One heatmap
#=========================================================================================
# 3) Plot full correlation heatmap
corrplot(cor_mat,
method = "color",
type   = "upper",
tl.col = "black",
tl.srt = 45,
number.cex = 0.5,
main  = "Correlation Heatmap of All Features")
#=========================================================================================
cor_long <- cor_mat %>%
as.data.frame() %>%
mutate(Var1 = rownames(.)) %>%
pivot_longer(-Var1, names_to = "Var2", values_to = "value")
ggplot(cor_long, aes(Var1, Var2, fill = value)) +
geom_tile(color = "white", size = 0.2) +
scale_fill_gradient2(
low = "#6BAED6", mid = "white", high = "#DE2D26",
midpoint = 0, limit = c(-1, 1), name = "Correlation"
) +
theme_minimal(base_size = 13) +
theme(
axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1),
panel.grid = element_blank()
) +
labs(
title = "Correlation Heatmap (ggplot2)",
x = "",
y = ""
)
#=========================================================================================
#This one better?can hover see the value
#=========================================================================================
#install.packages("heatmaply")
library(heatmaply)
heatmaply(
cor_mat,
colors = colorRampPalette(c("#2166AC", "white", "#B2182B"))(200),
k_row = 3,
k_col = 3,
main = "Interactive Correlation Heatmap"
)
#=========================================================================================
#=========================================================================================
#=========================================================================================
#=========================================================================================
# 4) Correlation list for BMI (regression task)
if ("BMI" %in% rownames(cor_mat)) {
bmi_cor <- sort(cor_mat["BMI", ], decreasing = TRUE)
cat("\nCorrelation with BMI:\n")
print(round(bmi_cor, 3))
} else {
warning("BMI not found in correlation matrix row names.")
}
# 5) Correlation list for HeartDisease (classification task)
if ("HeartDisease_num" %in% rownames(cor_mat)) {
hd_cor <- sort(cor_mat["HeartDisease_num", ], decreasing = TRUE)
cat("\nCorrelation with HeartDiseaseorAttack (0/1):\n")
print(round(hd_cor, 3))
} else {
warning("HeartDisease_num not found in correlation matrix row names.")
}
# ============================================================
# 10. Select features BEFORE split
# ============================================================
# Classification predictors (based on correlation + domain knowledge)
clf_features <- c(
"HeartDiseaseorAttack",     # target
"Age", "AgeGroup", "AgeBand",
"Sex",
"HighBP", "HighChol", "Diabetes", "Stroke",
"Smoker", "PhysActivity",
"PhysHlth", "MentHlth", "HealthStressIndex",
"DiseaseCount", "ObeseFlag",
"RiskScore", "LifestyleProfile",
# numeric columns that later need scaling
"BMI", "MentHlth", "PhysHlth"
)
df_clf_raw <- df_clean %>% select(all_of(clf_features))
# Regression predictors
reg_features <- c(
"BMI",                         # target
"Age", "AgeGroup", "AgeBand",
"Sex",
"HighBP", "HighChol", "Diabetes", "Stroke",
"Smoker", "PhysActivity",
"PhysHlth", "MentHlth", "HealthStressIndex",
"DiseaseCount", "RiskScore", "LifestyleProfile",
"Income", "Education"
)
df_reg_raw <- df_clean %>% select(all_of(reg_features))
#===============================================================
# 11. Train/Valid/Test Split
#===============================================================
set.seed(123)
n <- nrow(df_clean)
indices <- sample(seq_len(n))
train_size <- floor(0.6 * n)
valid_size <- floor(0.2 * n)
train_idx <- indices[1:train_size]
valid_idx <- indices[(train_size + 1):(train_size + valid_size)]
test_idx  <- indices[(train_size + valid_size + 1):n]
cat("\nTrain:", length(train_idx),
"\nValid:", length(valid_idx),
"\nTest:",  length(test_idx), "\n")
#===============================================================
# 12. BUILD DATASETS FOR BOTH TASKS (still unscaled)
#===============================================================
# CLASSIFICATION
train_clf <- df_clf_raw[train_idx, ]
valid_clf <- df_clf_raw[valid_idx, ]
test_clf  <- df_clf_raw[test_idx, ]
# Convert target to factor here
train_clf$HeartDisease <- factor(train_clf$HeartDiseaseorAttack, levels=c(0,1), labels=c("No","Yes"))
valid_clf$HeartDisease <- factor(valid_clf$HeartDiseaseorAttack, levels=c(0,1), labels=c("No","Yes"))
test_clf$HeartDisease  <- factor(test_clf$HeartDiseaseorAttack, levels=c(0,1), labels=c("No","Yes"))
train_clf <- train_clf %>% select(-HeartDiseaseorAttack) %>% relocate(HeartDisease)
valid_clf <- valid_clf %>% select(-HeartDiseaseorAttack) %>% relocate(HeartDisease)
test_clf  <- test_clf  %>% select(-HeartDiseaseorAttack) %>% relocate(HeartDisease)
# REGRESSION (target BMI)
train_reg <- df_reg_raw[train_idx, ]
valid_reg <- df_reg_raw[valid_idx, ]
test_reg  <- df_reg_raw[test_idx, ]
#===============================================================
# 13. Normalization
#===============================================================
# Columns to scale
scale_cols <- c("BMI", "MentHlth", "PhysHlth")
# Compute scaler parameters FROM TRAIN ONLY
scaler_means <- sapply(train_clf[, scale_cols], mean)
scaler_sds   <- sapply(train_clf[, scale_cols], sd)
# Scaling function
scale_apply <- function(df, cols, means, sds) {
df[, paste0(cols, "_scaled")] <- sweep(df[, cols], 2, means, FUN = "-") / sds
return(df)
}
# Apply scaling to ALL datasets (but fitted on TRAIN ONLY)
train_clf <- scale_apply(train_clf, scale_cols, scaler_means, scaler_sds)
valid_clf <- scale_apply(valid_clf, scale_cols, scaler_means, scaler_sds)
test_clf  <- scale_apply(test_clf,  scale_cols, scaler_means, scaler_sds)
train_reg <- scale_apply(train_reg, scale_cols, scaler_means, scaler_sds)
valid_reg <- scale_apply(valid_reg, scale_cols, scaler_means, scaler_sds)
test_reg  <- scale_apply(test_reg,  scale_cols, scaler_means, scaler_sds)
#===============================================================
# 14. Drop unscaled original variables ONLY if model does not need them
#===============================================================
# Remove unscaled if needed
train_clf <- train_clf %>% select(-BMI, -MentHlth, -PhysHlth)
valid_clf <- valid_clf %>% select(-BMI, -MentHlth, -PhysHlth)
test_clf  <- test_clf  %>% select(-BMI, -MentHlth, -PhysHlth)
# For Regression, KEEP original BMI (target), drop other unscaled ones
train_reg <- train_reg %>% select(-BMI_scaled,-MentHlth, -PhysHlth)
valid_reg <- valid_reg %>% select(-BMI_scaled,-MentHlth, -PhysHlth)
test_reg  <- test_reg  %>% select(-BMI_scaled,-MentHlth, -PhysHlth)
#===============================================================
# Data Preparation Complete
#===============================================================
cat("\n==== FINAL DATASET SHAPES ==== \n")
cat("\n[Classification]\n")
cat("Train:", nrow(train_clf), "rows,", ncol(train_clf), "columns\n")
cat("Valid:", nrow(valid_clf), "rows,", ncol(valid_clf), "columns\n")
cat("Test :", nrow(test_clf),  "rows,", ncol(test_clf),  "columns\n")
cat("\n[Regression]\n")
cat("Train:", nrow(train_reg), "rows,", ncol(train_reg), "columns\n")
cat("Valid:", nrow(valid_reg), "rows,", ncol(valid_reg), "columns\n")
cat("Test :", nrow(test_reg),  "rows,", ncol(test_reg),  "columns\n")
# ============================================================
# 15. Modelling
# ============================================================
# ============================================================
# 15A. Classification
# ============================================================
# ============================================================
# CLASSIFICATION PIPELINE FLOW
# ============================================================
# 1. df_clf = FACTOR ("No"/"Yes") target  → used for SMOTE
# 2. SMOTE requires FACTOR target → so keep "No"/"Yes" for SMOTE
# 3. XGBoost & LightGBM require NUMERIC (0/1) → convert AFTER SMOTE
# 4. Final models:
#       - LightGBM (trained on SMOTE data)
#       - XGBoost  (trained on original data with weights)
# ============================================================
# ============================================================
#          LIGHTGBM + SMOTE + BAYESIAN OPTIMIZATION
# ============================================================
# ============================================================
# 1.1 PREPARE DATA FOR MODELLING
# ============================================================
train_y_num <- ifelse(train_clf$HeartDisease == "Yes", 1, 0)
valid_y_num <- ifelse(valid_clf$HeartDisease == "Yes", 1, 0)
test_y_num  <- ifelse(test_clf$HeartDisease  == "Yes", 1, 0)
# Model Matrix (one-hot encoding)
X_train <- model.matrix(HeartDisease ~ ., train_clf)[, -1]
X_valid <- model.matrix(HeartDisease ~ ., valid_clf)[, -1]
X_test  <- model.matrix(HeartDisease ~ ., test_clf)[, -1]
# ============================================================
# 1.2 APPLY SMOTE TO TRAINING ONLY
# ============================================================
cat("\n--- Running SMOTE on training data ---\n")
df_smote_X <- as.data.frame(X_train)
df_smote_y <- factor(train_y_num, levels = c(0, 1))
smote_out <- SMOTE(
df_smote_X,
df_smote_y,
K = 5,
dup_size = 3
)
